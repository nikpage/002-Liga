<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<title>Aplikace Ot√°zky a Odpovƒõdi</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  max-width: 800px;
  margin: 50px auto;
  padding: 20px;
  background:#f0f2f5;
}

#chat-container{
  background:#fff;
  border-radius:10px;
  padding:20px;
  box-shadow:0 2px 10px rgba(0,0,0,.1);
  min-height:400px;
  display:flex;
  flex-direction:column;
}

#messages{
  flex-grow:1;
  overflow-y:auto;
  margin-bottom:20px;
  max-height:500px;
  display:flex;
  flex-direction:column;
}

.message{
  margin-bottom:20px;
  padding:15px;
  border-radius:15px;
  max-width:85%;
  line-height:1.6;
}

.user-msg{
  background:#007bff;
  color:#fff;
  align-self:flex-end;
}

.bot-msg{
  background:#e4e6eb;
  color:#000;
}

/* ==== FORCED FORMATTING ==== */
.bot-msg h1{
  font-size:1.6em;
  margin-top:1.2em;
}
.bot-msg h2{
  font-size:1.3em;
  margin-top:1em;
}
.bot-msg h3{
  font-size:1.1em;
  margin-top:.8em;
}
.bot-msg ul, .bot-msg ol{
  padding-left:1.2em;
}
.bot-msg a{
  color:#0056b3;
  text-decoration:underline;
}
/* ========================== */

.controls-area{
  display:flex;
  gap:10px;
  align-items:center;
}

input[type="text"]{
  flex-grow:1;
  padding:12px;
  border-radius:5px;
  border:1px solid #ccc;
  font-size:16px;
}

#sendBtn{
  padding:12px 25px;
  border:none;
  border-radius:5px;
  background:#28a745;
  color:#fff;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
}

#progress-indicator{
  margin-top:10px;
  padding:10px;
  background:#fff;
  border:1px solid #ccc;
  border-radius:5px;
  display:none;
  text-align:center;
  font-weight:bold;
}
</style>
</head>

<body>
<div id="chat-container">
  <h2>Aplikace Ot√°zky a Odpovƒõdi üß†</h2>
  <div id="messages"></div>

  <div class="controls-area">
    <input id="query" type="text" placeholder="Zadejte dotaz..."
      onkeydown="if(event.key==='Enter') ask()" />
    <button id="sendBtn" onclick="ask()">Odeslat</button>
  </div>

  <div id="progress-indicator">Prob√≠h√° zpracov√°n√≠‚Ä¶</div>
</div>

<script>
let chatHistory=[];
const progressIndicator=document.getElementById('progress-indicator');

function normalizeAnswer(md){
  if(!md) return md;

  // 1) Force emoji sections to correct format
  md = md
    .replace(/^üí°.*$/gm,"üí°\n# Shrnut√≠")
    .replace(/^üìã.*$/gm,"üìã\n# Podrobnosti")
    .replace(/^üìÑ.*$/gm,"üìÑ\n# Zdroje");

  // 2) Clean up technical filenames in URLs to readable titles
  function cleanTitle(filename) {
    return filename
      .replace(/\.(pdf|docx?|xlsx?|txt)$/i, '')
      .replace(/[_-]+/g, ' ')
      .replace(/pujcovny pomucek pujcovny/gi, 'P≈Øjƒçovny pom≈Øcek')
      .replace(/^(\w)/, (m) => m.toUpperCase())
      .trim();
  }

  // 3) Convert raw URLs in source lists to numbered readable links
  let sourceNum = 0;
  md = md.replace(/^[‚Ä¢*-]\s*(https?:\/\/\S+)/gm, (match, url) => {
    sourceNum++;
    const filename = url.split('/').pop();
    const title = cleanTitle(filename);
    return `- [${title}](${url}) [${sourceNum}]`;
  });

  // 4) Find inline URLs and convert to numbered references
  const urlPattern = /(?<!\[)\bhttps?:\/\/[^\s\)]+/g;
  const foundUrls = [];
  md = md.replace(urlPattern, (url) => {
    let idx = foundUrls.indexOf(url);
    if (idx === -1) {
      foundUrls.push(url);
      idx = foundUrls.length - 1;
    }
    return `[${idx + 1}]`;
  });

  return md.trim();
}

function addMessage(role,content){
  const msgs=document.getElementById('messages');
  const div=document.createElement('div');
  div.className='message '+(role==='user'?'user-msg':'bot-msg');
  div.innerHTML=marked.parse(content);
  msgs.appendChild(div);
  div.scrollIntoView({behavior:'smooth',block:'end'});
}

async function ask(){
  const input=document.getElementById('query');
  const btn=document.getElementById('sendBtn');
  const q=input.value.trim();
  if(!q) return;

  addMessage('user',q);
  chatHistory.push({role:'user',content:q});
  input.value='';
  btn.disabled=true;
  progressIndicator.style.display='block';

  try{
    const res=await fetch('/.netlify/functions/search',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        query:
          "Odpov√≠dej pouze v ƒçe≈°tinƒõ.\n"+
          "V√ùSTUP MUS√ç B√ùT STRUKTUROVAN√ù:\n"+
          "- Sekce: emoji na ≈ô√°dku, pak H1 (2‚Äì5 slov)\n"+
          "- Podsekce H2/H3\n"+
          "- Kr√°tk√© texty, seznamy, tabulky\n"+
          "- Odkazy jen z DB, ≈æ√°dn√© hol√© URL\n"+
          "- Zdroje ƒç√≠slovan√©, max 3 prim√°rn√≠\n"+
          "Dotaz: "+q,
        history:chatHistory
      })
    });

    const data=await res.json();
    progressIndicator.style.display='none';
    const out=normalizeAnswer(data.answer);
    addMessage('assistant',out);
    chatHistory.push({role:'assistant',content:out});
  }catch(e){
    progressIndicator.style.display='none';
    addMessage('assistant','CHYBA SYST√âMU');
  }finally{
    btn.disabled=false;
  }
}
</script>
</body>
</html>
