<!DOCTYPE html>
<html>
<head>
    <title>Aplikace Ot√°zky a Odpovƒõdi</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; background-color: #f0f2f5; }

        #chat-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        #messages { flex-grow: 1; overflow-y: auto; margin-bottom: 20px; max-height: 500px; }

        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 15px; max-width: 80%; line-height: 1.5; }
        .user-msg { background-color: #007bff; color: white; align-self: flex-end; margin-left: auto; }
        .bot-msg { background-color: #e4e6eb; color: black; align-self: flex-start; }

        /* Controls Area */
        .controls-area { display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
        button { padding: 10px 15px; border: none; border-radius: 5px; background-color: #28a745; color: white; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        select { padding: 10px; border-radius: 5px; border: 1px solid #ccc; }

        /* Progress Indicator Styles */
        #progress-indicator {
            margin-top: 5px; /* Spacing below the controls */
            padding: 10px;
            background-color: white; /* No yellow background */
            border: 1px solid #ccc; /* Simple border for visibility */
            border-radius: 5px;
            display: none; /* Hidden by default */
            color: #333; /* Default text color */
            font-weight: bold;
        }
        /* Error state class */
        #progress-indicator.error {
            color: red; /* Red text on error */
            border-color: red;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <h2>Aplikace Ot√°zky a Odpovƒõdi üß†</h2>
        <div id="messages"></div>

        <div class="controls-area">
            <select id="modelSelect">
                <option value="gemini-2.5-flash" selected>‚ö° Gemini 2.5 Flash (Rychl√Ω)</option>
                <option value="gemini-3-pro-preview">üß† Gemini 3 Pro (Chytr√Ω)</option>
            </select>
            <input type="text" id="question" placeholder="Zadejte svou ot√°zku zde...">
            <button id="sendBtn" onclick="ask()">Odeslat</button>
        </div>

        <div id="progress-indicator">Prob√≠h√° G3 my≈°len√≠...</div>

    </div>

    <script>
        // Array for chat history
        let chatHistory = [];
        let progressInterval = null;
        const progressIndicator = document.getElementById('progress-indicator');

        // Progress messages (Total 27 stages)
        const progressStages = [
            // REAL Stage 1 (3-second interval starts here)
            "Dotaz Odesl√°n do AI üß†...",

            // Real Stages (3)
            "Vkl√°d√°n√≠ dotazu do vektoru üîç...",
            "Hled√°n√≠ kontextu v Neo4j datab√°zi üíæ...",
            "Zah√°jen√≠ G3 my≈°len√≠ üí°...",

            // Funny/Unrealistic Stages (23) - Randomized after the first 4 stages
            "Krmen√≠ datov√©ho jednoro≈æce ü¶Ñ...",
            "G3 si zavazuje tkaniƒçky üëü...",
            "P≈ôepoƒç√≠t√°v√°n√≠ danƒõ z hlouposti üí∞...",
            "Kontrola, zda m√° G3 dostatek k√°vy ‚òï...",
            "Synchronizace s vesm√≠rn√Ωmi daty ‚ú®...",
            "Model se h√°d√° s datab√°z√≠ ü§¨...",
            "Hled√°n√≠ odpovƒõdi v archivn√≠ch memech üñºÔ∏è...",
            "ƒåek√°n√≠, ne≈æ n√°m dojde toner üñ®Ô∏è...",
            "Tr√©nink psa na aport odpovƒõdi üêï...",
            "Mƒõ≈ôen√≠ kvantov√©ho ≈°umu üî≠...",
            "√öplatky pro lok√°ln√≠ server üí∏...",
            "Kontrola, zda se ƒças nezkroutil ‚è≥...",
            "Model si d√°v√° siestu na slunci ‚òÄÔ∏è...",
            "Ladƒõn√≠ odpovƒõdi v bin√°rn√≠ poezii üìú...",
            "Filtrov√°n√≠ konspiraƒçn√≠ch teori√≠ üëΩ...",
            "P≈ô√≠prava na koneƒçnou zkou≈°ku vesm√≠ru üåå...",
            "Generov√°n√≠ n√°hodn√Ωch ƒç√≠sel pro ≈°tƒõst√≠ üçÄ...",
            "Tanec pro rychlej≈°√≠ WiFi üíÉ...",
            "Zji≈°≈•ov√°n√≠, kdo vypnul a zapnul üîå...",
            "T≈ô√≠dƒõn√≠ pono≈æek podle barev üåà...",
            "Psan√≠ dopisu Nostradamovi üîÆ...",
            "Poƒç√≠t√°n√≠, kolikr√°t jsem se zm√Ωlil üî¢...",
            "Kontrola, zda jsem to n√°hodou neukradl üòà..."
        ];

        const FUNNY_STAGES_START_INDEX = 4;
        const INTERVAL_TIME = 3000; // 3 seconds per stage

        function addMessage(role, content) {
            const msgs = document.getElementById('messages');
            const newMsg = document.createElement('div');
            newMsg.classList.add('message');
            newMsg.classList.add(role === 'user' ? 'user-msg' : 'bot-msg');
            newMsg.innerHTML = marked.parse(content);
            msgs.appendChild(newMsg);
            // Scroll to bottom
            msgs.scrollTop = msgs.scrollHeight;
        }

        function startProgress() {
            progressIndicator.style.display = 'block';
            progressIndicator.classList.remove('error'); // Clear error state
            let stageIndex = 0;

            // Cycle through all stages every 3000ms.
            progressInterval = setInterval(() => {
                let index = stageIndex % progressStages.length;

                // Show the first 4 real stages sequentially (0, 1, 2, 3)
                if (stageIndex < FUNNY_STAGES_START_INDEX) {
                   progressIndicator.textContent = progressStages[index];
                } else {
                   // Then start cycling/shuffling the funny stages (index 4 onwards)
                   let funnyStages = progressStages.slice(FUNNY_STAGES_START_INDEX);
                   let randomIndex = Math.floor(Math.random() * funnyStages.length);
                   progressIndicator.textContent = funnyStages[randomIndex];
                }

                // Advance the index
                stageIndex++;
            }, INTERVAL_TIME); // 3000ms interval
        }

        function stopProgress(isError = false) {
            clearInterval(progressInterval);
            if (isError) {
                // Keep the indicator visible but change color/text on error
                progressIndicator.textContent = "CHYBA: Zpracov√°n√≠ selhalo.";
                progressIndicator.classList.add('error');
            } else {
                // Hide on success
                progressIndicator.style.display = 'none';
            }
        }

        async function ask() {
            const input = document.getElementById('question');
            const btn = document.getElementById('sendBtn');
            const modelSelector = document.getElementById('modelSelect');

            const question = input.value.trim();
            const selectedModel = modelSelector.value;

            if (!question) return;

            addMessage('user', question);
            input.value = '';
            btn.disabled = true;
            chatHistory.push({ role: "user", content: question });

            startProgress();

            try {
                // Send Model Choice and History to Server
                const response = await fetch('/.netlify/functions/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question,
                        history: chatHistory,
                        model: selectedModel
                    })
                });

                // Check for HTTP errors (e.g., 500, 404, etc.)
                if (!response.ok) {
                    const errorData = await response.json();
                    stopProgress(true); // Stop with error state
                    addMessage('assistant', 'CHYBA SERVERU: Selhalo p≈ôipojen√≠ nebo chyba. Odpovƒõƒè: ' + errorData.answer);
                    return;
                }

                // If successful:
                stopProgress(false); // Stop with success state
                const data = await response.json();
                addMessage('assistant', data.answer);
                chatHistory.push({ role: "assistant", content: data.answer });

            } catch (error) {
                // Catch network errors (e.g., server not running)
                stopProgress(true); // Stop with error state
                addMessage('assistant', 'CHYBA SYST√âMU: Nepoda≈ôilo se p≈ôipojit k lok√°ln√≠mu serveru. Ujistƒõte se, ≈æe bƒõ≈æ√≠ (npm start).');
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
